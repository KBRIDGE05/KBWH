<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KBridge KBRIDGE / LCL ì°½ê³ ë£Œ ê³„ì‚°ê¸°</title>
<style>
  :root{
    --bg:#f8fafc;           /* light only */
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --primary:#2563eb;      /* KB ê¸°ë³¸ íŒŒë‘í†¤ ì œì•ˆ */
    --accent:#0ea5e9;
    --border:#e2e8f0;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif;font-size:15px;line-height:1.5}
  .wrap{max-width:900px;margin:14px auto;padding:0 10px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  header h1{font-size:20px;margin:0;font-weight:800;letter-spacing:-0.2px}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:#fff;background:var(--primary);padding:4px 10px;border-radius:999px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 16px 12px 16px;box-shadow:0 4px 12px rgba(15,23,42,.06)}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}
  .layout{display:grid;grid-template-columns:1fr;gap:12px}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}}
  .pane-title{font-weight:900;font-size:12px;color:var(--muted);margin-bottom:6px;letter-spacing:.2px}

  label.lbl{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  /* ì„ íƒ í•„ìˆ˜ ì •ë³´ ê°€ì‹œì„± ê°•í™” */
  .lbl.big{font-size:14px;color:var(--text);font-weight:900}
  .key .seg button{font-size:15px;min-height:46px;padding:12px 14px}
  .key input[type="number"], .key input[type="text"], .key select{font-size:15px;padding:10px 12px}
  .key .ico{width:20px;height:20px}

  .seg{display:flex;flex-wrap:wrap;gap:2px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#fff}
  .seg button{flex:1 1 auto;display:flex;align-items:center;justify-content:center;gap:8px;border:0;background:#fff;padding:12px 14px;font-weight:800;font-size:14.5px;color:var(--muted);cursor:pointer;min-height:46px;letter-spacing:-0.2px}
  .seg button.active{background:var(--primary);color:#fff}

  input[type="number"],input[type="text"],select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
  .hint{font-size:12px;color:var(--muted)}
  .ico{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:6px;background:#eef2ff;border:1px solid #c7d2fe;font-size:12px;line-height:1}
  .btn .ico{margin-right:6px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--primary);background:var(--primary);color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 3px 10px rgba(37,99,235,.2)}
  .btn.secondary{background:#fff;color:var(--primary)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .totals{display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:8px 10px;border-radius:999px;font-size:12.5px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  /* ê²°ê³¼ ê°€ì‹œì„± í–¥ìƒ */
  #resultSec h3{font-size:18px}
  #resultSec table{font-size:14.5px}
  #resultSec thead th{font-size:13.5px}
  #resultSec tbody td{padding:12px 10px}
  #resultSec tbody td:first-child{font-weight:600}
  #resultSec tbody td:last-child{font-variant-numeric:tabular-nums;letter-spacing:0.2px}
  #resultSec tfoot td{font-size:20px;background:#eaf3ff}
  #resultSec tfoot td:last-child{font-variant-numeric:tabular-nums;letter-spacing:0.3px}
  th,td{padding:10px;border-bottom:1px dashed var(--border);text-align:right}
  th:first-child,td:first-child{text-align:left}
  tfoot td{font-weight:800}
  .port-wrap{display:grid;gap:12px}
  @media(min-width:900px){.port-wrap.two{grid-template-columns:1fr 1fr}}
  .subtle{font-size:12px;color:var(--muted)}
  .mini{font-size:11px}
  .footer{margin-top:16px;color:var(--muted);font-size:12px}
  .portbar{display:flex;align-items:center;gap:10px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:12px 14px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#fff;font-weight:800;cursor:pointer;min-height:44px; background: var(--primary)}
  .chip.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 12px rgba(37,99,235,.25)}
  .viewmode{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .dim-row{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff;margin-bottom:10px}
  .dim-grid{display:grid;gap:8px;grid-template-columns:repeat(5,minmax(0,1fr))}
  @media (max-width:800px){.dim-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .sublbl{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
  .dim-actions{display:flex;justify-content:flex-end;margin-top:6px}
@media (max-width:480px){
  .wrap{padding:0 12px}
  input[type="text"],input[type="number"],select{font-size:16px}
  .seg button,.btn,.chip{min-height:48px}
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>LCL ì°½ê³ ë£Œ ê³„ì‚°ê¸° - KBRIDGEì œì‘</h1>
    </header>

    <div class="layout">
      <!-- ì¢Œì¸¡: ì…ë ¥/ìš”ì•½ -->
      <aside class="left">
        <div class="card" style="margin-bottom:12px">
          <div class="pane-title">ë„ì°©í•­</div>
          <div class="portbar" role="tablist" aria-label="ë„ì°©í•­ ì„ íƒ">
            <div class="seg" id="segPorts">
              <button id="portICN" data-port="ICN" type="button"><span class="ico">âš“</span><span>ì¸ì²œí•­</span></button>
              <button id="portPUS" data-port="PUS" type="button"><span class="ico">âš“</span><span>ë¶€ì‚°í•­</span></button>
            </div>
            <button id="portALL" class="chip active" data-port="ALL" type="button"><span class="ico">ğŸ§©</span><span>ì „ì²´ ë¹„êµ</span></button>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div class="pane-title">ë³´ê´€ ì •ë³´</div>
          <div class="grid cols-2">
            <div>
              <label class="lbl">ì°½ê³  ë³´ê´€ ì¼ìˆ˜</label>
              <input id="days" type="number" min="0" step="1" placeholder="ì˜ˆ: 3" />
              <div class="hint">ë°˜ì…ì¼ í¬í•¨ Â· 7ì¼ ì´ˆê³¼ ì‹œ ì¥ê¸°ë³´ê´€ í• ì¦ ê·œì¹™</div>
            </div>
            <div>
              <label class="lbl">CIF VALUE (KRW)</label>
              <input id="cif" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ì˜ˆ: 5,000,000" />
              <div class="hint">CIF = ë¬¼í’ˆê°€ê²© + êµ­ì œìš´ì†¡ë£Œ + ì í•˜ë³´í—˜ë£Œ</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div class="pane-title">í™”ë¬¼ ì •ë³´</div>
          <div class="key">
            <div class="seg" style="margin-bottom:10px">
              <button id="modeCBM" class="active" data-mode="cbm" type="button"><span class="ico">ğŸ“¦</span><span>CBM ì§ì ‘ ì…ë ¥</span></button>
              <button id="modeDIMS" data-mode="dims" type="button"><span class="ico">ğŸ“</span><span>í™”ë¬¼ ì‚¬ì´ì¦ˆ ì…ë ¥</span></button>
            </div>
            <div id="cbmBox">
              <div class="row">
                <div>
                  <label class="lbl">ì´ CBM (mÂ³)</label>
                  <input id="cbm" type="number" min="0" step="0.001" placeholder="ì˜ˆ: 1.6" />
                </div>
                <div>
                  <label class="lbl">ì´ ì¤‘ëŸ‰ (kg)</label>
                  <input id="weight" type="number" min="0" step="0.1" placeholder="ì˜ˆ: 120" />
                </div>
                <div>
                  <label class="lbl">ì´ PCS</label>
                  <input id="pcs" type="number" min="0" step="1" placeholder="ì˜ˆ: 4" />
                </div>
              </div>
            </div>
            <div id="dimsBox" style="display:none">
              <div id="dimRows"></div>
              <button class="btn secondary mini" id="addRow" type="button">+ ì‚¬ì´ì¦ˆ ì¶”ê°€</button>
              <div class="hint" style="margin-top:6px">ë‹¨ìœ„: cm (ê¸¸ì´Ã—ë„ˆë¹„Ã—ë†’ì´), ì¤‘ëŸ‰ kg. ê° í–‰ì˜ <b>PCS</b>ë§Œí¼ í•©ì‚°ë©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div class="pane-title">ìš”ì•½</div>
          <div class="totals" id="totals"></div>
          <div class="row" style="margin-top:10px">
            <button id="calc" class="btn" type="button"><span class="ico">ğŸ§®</span>ê³„ì‚°í•˜ê¸°</button>
            <button id="reset" class="btn secondary" type="button"><span class="ico">â™»</span>ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="subtle">Â© 2025 KBridge Â· ì™¸ë¶€ ì„œë¹„ìŠ¤ UIë¥¼ ë³µì œí•˜ì§€ ì•Šê³  ê¸°ëŠ¥ë§Œ ì°¸ê³ í•˜ì—¬ ì œì‘</div>
      </aside>

      <!-- ìš°ì¸¡: ê²°ê³¼ -->
      <main class="right">
        <section id="resultSec" class="card" style="display:none">
          <div class="viewmode"><span class="badge" id="viewModeLabel">ë³´ê¸°: ì „ì²´ ë¹„êµ</span></div>
          <div class="subtle" style="margin-bottom:8px">ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©° ì‹¤ì œ ì²­êµ¬ëŠ” ì°½ê³ ì‚¬/í¬ì›Œë” ìš”ìœ¨ ë° ì •ì±…ì— ë”°ë¦…ë‹ˆë‹¤.</div>
          <div id="portResults" class="port-wrap"></div>
        </section>
      </main>
    </div>
  </div>

<script>
// ======================== ì „ì—­ ìƒíƒœ & í•¸ë“¤ëŸ¬ ========================
var selectedPort = 'ALL';
var mode = 'cbm';
var lastInputs = null; // ìµœê·¼ ê³„ì‚° ì…ë ¥ê°’ ìºì‹œ

// ê³µìš© í¬ë§·í„° & throttle
const NF = new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 });
const NF_DEC = new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 3 });
function throttle(func, wait){
  let timeout=null, last=0, trailingArgs=null;
  return function(){
    const now=Date.now();
    const remaining = wait - (now - last);
    const ctx=this, args=arguments;
    if(remaining <= 0){ last=now; func.apply(ctx,args); }
    else{
      trailingArgs=args;
      if(!timeout){ timeout=setTimeout(function(){ timeout=null; last=Date.now(); func.apply(ctx,trailingArgs); trailingArgs=null; }, remaining); }
    }
  }
}

function setActiveInGroup(btn){
  var group = btn && btn.closest ? btn.closest('.seg') : null;
  if(group){ group.querySelectorAll('button').forEach(function(b){ b.classList.remove('active'); }); }
  if(btn){ btn.classList.add('active'); }
}
function handlePort(btn){
  try{
    document.querySelectorAll('button[data-port]').forEach(function(b){ b.classList.remove('active'); });
    if(btn){ btn.classList.add('active'); }
    selectedPort = btn ? btn.getAttribute('data-port') : selectedPort;
    // í¬íŠ¸ ë³€ê²½ ì‹œ ìƒë‹¨ ìš”ì•½(ì ìš© ê³¼ê¸ˆ CBM) ì¦‰ì‹œ ê°±ì‹ 
    if(typeof updateTotalsView==='function'){
      var t = lastInputs ? lastInputs.totals : {pcs:0,cbm:0,kg:0,rt:0,chargeable:0};
      updateTotalsView(t);
    }
    if(typeof renderResults==='function'){ renderResults(); }
  }catch(e){ /* no-op */ }
}
function ensureDimsUI(){
  var dimsBox=document.getElementById('dimsBox');
  if(!dimsBox) return;
  var dimRows=document.getElementById('dimRows');
  if(!dimRows){
    dimsBox.innerHTML = '<div id="dimRows"></div><button class="btn secondary mini" id="addRow" type="button">+ ì‚¬ì´ì¦ˆ ì¶”ê°€</button><div class="hint" style="margin-top:6px">ë‹¨ìœ„: cm (ê¸¸ì´Ã—ë„ˆë¹„Ã—ë†’ì´), ì¤‘ëŸ‰ kg. ê° í–‰ì˜ <b>PCS</b>ë§Œí¼ í•©ì‚°ë©ë‹ˆë‹¤.</div>';
    dimRows = document.getElementById('dimRows');
  }
  if(dimRows.children.length===0){ addDimRow(); }
  var addBtn=document.getElementById('addRow');
  if(addBtn && !addBtn.__kb_bound){ addBtn.addEventListener('click', function(){ addDimRow(); }); addBtn.__kb_bound=true; }
}
function handleMode(btn){
  setActiveInGroup(btn);
  mode = btn.getAttribute('data-mode');
  var cbmBox=document.getElementById('cbmBox');
  var dimsBox=document.getElementById('dimsBox');
  if(cbmBox && dimsBox){
    cbmBox.style.display=(mode==='cbm')?'block':'none';
    dimsBox.style.display=(mode==='dims')?'block':'none';
  }
  if(mode==='dims'){ ensureDimsUI(); }
}

// ë²„íŠ¼ ë°”ì¸ë”©(ì§ì ‘)
document.addEventListener('DOMContentLoaded', function(){
  // í¬íŠ¸/ëª¨ë“œ íƒ­
  var elAll=document.getElementById('portALL'); if(elAll) elAll.addEventListener('click', function(){ handlePort(this); });
  var elICN=document.getElementById('portICN'); if(elICN) elICN.addEventListener('click', function(){ handlePort(this); });
  var elPUS=document.getElementById('portPUS'); if(elPUS) elPUS.addEventListener('click', function(){ handlePort(this); });
  var elMC=document.getElementById('modeCBM'); if(elMC) elMC.addEventListener('click', function(){ handleMode(this); });
  var elMD=document.getElementById('modeDIMS'); if(elMD) elMD.addEventListener('click', function(){ handleMode(this); });
  // ê³„ì‚°/ì´ˆê¸°í™” ë²„íŠ¼
  var elCalc=document.getElementById('calc'); if(elCalc) elCalc.addEventListener('click', onCalcClick);
  var elReset=document.getElementById('reset'); if(elReset) elReset.addEventListener('click', onResetClick);
  // ì´ˆê¸° UI ì¤€ë¹„
  ensureDimsUI();
  bindCifFormatter();
  bindLiveTotals();
  updateTotalsView({pcs:0,cbm:0,kg:0,rt:0,chargeable:0});
});

// ======================== ìœ í‹¸ & ì…ë ¥ í•©ì‚° ========================
function fmtKRW(n){ if(!isFinite(n)) return '-'; return NF.format(Math.round(n))+'ì›'; }
function pill(label, value){ const span=document.createElement('span'); span.className='pill'; span.textContent=`${label}: ${value}`; return span; }

function addDimRow(data){
  data = Object.assign({L:'',W:'',H:'',KG:'',PCS:1}, data||{});
  const dimRows = document.getElementById('dimRows');
  const row = document.createElement('div');
  row.className='dim-row';
  row.innerHTML = `
    <div class="dim-grid">
      <div class="field"><label class="sublbl">ê¸¸ì´ (cm)</label><input type="number" step="0.1" min="0" placeholder="ì˜ˆ: 100" value="\${data.L}"></div>
      <div class="field"><label class="sublbl">ë„ˆë¹„ (cm)</label><input type="number" step="0.1" min="0" placeholder="ì˜ˆ: 50" value="\${data.W}"></div>
      <div class="field"><label class="sublbl">ë†’ì´ (cm)</label><input type="number" step="0.1" min="0" placeholder="ì˜ˆ: 40" value="\${data.H}"></div>
      <div class="field"><label class="sublbl">ì¤‘ëŸ‰ (kg/PCS)</label><input type="number" step="0.1" min="0" placeholder="ì˜ˆ: 20" value="\${data.KG}"></div>
      <div class="field"><label class="sublbl">PCS</label><input type="number" step="1" min="1" placeholder="ì˜ˆ: 2" value="\${data.PCS}"></div>
    </div>
    <div class="dim-actions"><button class="btn secondary mini" type="button">ì‚­ì œ</button></div>`;
  row.querySelector('.dim-actions button').addEventListener('click', function(){ row.remove(); });
  dimRows.appendChild(row);
}



function updateTotalsView(t){
  const box=document.getElementById('totals');
  if(!box) return;
  box.innerHTML='';
  box.appendChild(pill('ì´ PCS', t.pcs));
  box.appendChild(pill('ì´ CBM', t.cbm.toFixed(3)));
  box.appendChild(pill('ì´ ì¤‘ëŸ‰', t.kg.toFixed(1)+' kg'));
  box.appendChild(pill('ì…ë ¥ R/T', t.rt.toFixed(3)));
  // ì„ íƒ í¬íŠ¸ì— ë”°ë¥¸ ìµœì†Œ ê³¼ê¸ˆ CBM ì ìš© í‘œì‹œ (ICN=2, PUS=1)
  let applied = '-';
  if(selectedPort==='ICN' || selectedPort==='PUS'){
    const min = (RATES.ports[selectedPort] && RATES.ports[selectedPort].minCBM != null ? RATES.ports[selectedPort].minCBM : ((RATES.common && RATES.common.minCBM) || 0));
    applied = Math.max(t.rt, min).toFixed(3);
  }
  box.appendChild(pill('ì ìš© ê³¼ê¸ˆ CBM', applied));
}

function gatherTotals(){
  let pcs=0, cbm=0, kg=0;
  if(mode==='cbm'){
    cbm = parseFloat(document.getElementById('cbm').value||0);
    kg  = parseFloat(document.getElementById('weight').value||0);
    pcs = parseInt(document.getElementById('pcs').value||0);
  }else{
    const dimRows = document.getElementById('dimRows');
    for(const r of Array.from(dimRows.children)){
      const [L,W,H,KG,PCS] = r.querySelectorAll('input');
      const Lm=parseFloat(L.value||0)/100, Wm=parseFloat(W.value||0)/100, Hm=parseFloat(H.value||0)/100;
      const pcsN=parseInt(PCS.value||0), kgPer=parseFloat(KG.value||0);
      cbm += (Lm*Wm*Hm) * pcsN; // mÂ³
      kg  += kgPer * pcsN;
      pcs += pcsN;
    }
  }
  const rt = Math.max(cbm, kg/1000); // W/M
  const chargeable = rt; // í¬íŠ¸ë³„ minCBMì€ calcForPortì—ì„œ ì ìš©
  return {pcs, cbm, kg, rt, chargeable};
}

// ======================== ìš”ìœ¨ ë°°ì—´(ë¶€ì‚°) â†’ RATES ========================
// â—ï¸ì¤‘ìš”: RATESì—ì„œ ì°¸ì¡°í•˜ê¸° ì „ì— ë¨¼ì € ì´ˆê¸°í™”í•œë‹¤.
const __PUS_AD_BASE__ = [4.9,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7,3.7];
const __PUS_AD_DAILY__ = [0,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6,1.6];
const __PUS_WT_BASE__ = [8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000,8000];
const __PUS_WT_DAILY__ = [0,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000,4000];
// === ICN(ì¸ì²œ) ìš”ìœ¨: PDF ê¸°ì¤€ ìƒìˆ˜ ì ìš© ===
const __ICN_AD_BASE__   = Array(61).fill(1.68);   // ì¢…ê°€ ê¸°ë³¸ìš”ìœ¨(â€°)
const __ICN_AD_DAILY__  = Array(61).fill(0.27);   // ì¢…ê°€ ì¼í• ì¦(â€°/day)
const __ICN_WT_BASE__   = Array(61).fill(1610);   // ì¢…ëŸ‰ ê¸°ë³¸ìš”ìœ¨(ì›/CBMÂ·day)
const __ICN_WT_DAILY__  = Array(61).fill(240);    // ì¢…ëŸ‰ ì¼í• ì¦(ì›/CBMÂ·ì¶”ê°€ì¼)

const RATES = {
  common: {
    vatPct: 10,
    minCBM: 2,
    minStorageSubtotal: 50000,
    shipperCodeFeeFlat: 2000,
    storageBreakdownPct: { base: 60, daily: 25, weight: 10, inout: 5 },
    labels: {
      storage: { title: 'ë³´ê´€ë£Œ', base: 'ì¼ì¼ì°½ê³ ë£Œ', daily: 'ì¼ì¼í• ì¦ë£Œ', weight: 'ì¤‘ëŸ‰ë£Œ', inout: 'ì…Â·ë°˜ì…í• ì¦ë£Œ', subtotal: 'ë³´ê´€ë£Œ ì†Œê³„', minNote: 'ë³´ê´€ë£Œ ìµœì € ìš”ê¸ˆ : 50,000ì›' },
      work: { title: 'ì‘ì—…ë£Œ', subtotal: 'ì‘ì—…ë£Œ ì†Œê³„' },
      vat: 'ë¶€ê°€ì„¸', shipperCode: 'í™”ì£¼ë²ˆí˜¸ë£Œ', grandTotal: 'ì´ í•©ê³„'
    },
    managementFeePctOfCIF: 0
  },
  ports: {
    ICN: {
      name: 'ì¸ì²œ', minCBM: 2,
      mode: 'table', // 'table' = ì—‘ì…€ ìš”ìœ¨í‘œ ë°©ì‹
      table: {
        adValorem: { scale: 1.0 },
        weight: { scaleBase: 1.0, scaleDaily: 1.0 },
        basePermilleByDay: __ICN_AD_BASE__,
        dailyPermilleByDay: __ICN_AD_DAILY__,
        basePerCbmPerDayByDay: __ICN_WT_BASE__,
        dailyPerCbmPerDayByDay: __ICN_WT_DAILY__
      },
      workItems: [ { label: 'ì…ê³ í•˜ì°¨ë£Œ', amount: 8800 }, { label: 'ì¶œê³ ìƒì°¨ë£Œ', amount: 8800 }, { label: 'ì¸ì¶œë£Œ', amount: 3230 } ]
    },
    PUS: {
      name: 'ë¶€ì‚°', minCBM: 1, mode: 'table',
      table: {
        adValorem: { scale: 1.0 }, weight: { scaleBase: 1.0, scaleDaily: 1.0 },
        basePermilleByDay: __PUS_AD_BASE__,
        dailyPermilleByDay: __PUS_AD_DAILY__,
        basePerCbmPerDayByDay: __PUS_WT_BASE__,
        dailyPerCbmPerDayByDay: __PUS_WT_DAILY__
      },
      workItems: [ { label: 'ì¶œê³ ë£Œ / ìƒì°¨ë£Œ', amount: 12000 }, { label: 'ì¤‘ëŸ‰í• ì¦ë£Œ', amount: 6600 }, { label: 'EDI ì „ì†¡ë£Œ', amount: 10000 }, { label: 'ì„ ë³„í• ì¦ë£Œ', amount: 6600 } ]
    }
  }
};

// ======================== ê³„ì‚° ë¡œì§ & ì¶œë ¥ ========================
function calcForPort(portKey, totals, days, cif){
  const cfg = RATES.ports[portKey];
  const c = RATES.common;
  const minCBM = cfg.minCBM ?? c.minCBM ?? 0;
  const billCbm = Math.max(totals.chargeable, minCBM);

  let storageSubtotal = 0, storageBreakdown = [];
  if(cfg.mode==='table'){
    const tb = cfg.table;
    if((tb.basePermilleByDay||[]).length===0){
      // ì¸ì²œì€ ë¶€ì‚° ë°°ì—´ì„ ê³µìœ  (í˜„ì¬ëŠ” ICN ë°°ì—´ì„ ëª…ì‹œ ì ìš©í•˜ë¯€ë¡œ í†µìƒ ì§„ì…í•˜ì§€ ì•ŠìŒ)
      tb.basePermilleByDay = RATES.ports.PUS.table.basePermilleByDay;
      tb.dailyPermilleByDay = RATES.ports.PUS.table.dailyPermilleByDay;
      tb.basePerCbmPerDayByDay = RATES.ports.PUS.table.basePerCbmPerDayByDay;
      tb.dailyPerCbmPerDayByDay = RATES.ports.PUS.table.dailyPerCbmPerDayByDay;
    }
    const d = Math.min(days, tb.basePermilleByDay.length-1);
    const ad_rate_permille = (tb.basePermilleByDay[d]||0) + (tb.dailyPermilleByDay[d]||0)*Math.max(days-1,0);
    const ad_amount = Math.max(0, Math.round((cif * ad_rate_permille * ((tb.adValorem && tb.adValorem.scale) || 1))/1000));

    const wt_base = tb.basePerCbmPerDayByDay[d]||0;
    const wt_daily = tb.dailyPerCbmPerDayByDay[d]||0;
    const wt_amount = Math.max(0, Math.round(((wt_base*days)+(wt_daily*Math.max(days-1,0))) * billCbm * ((tb.weight && tb.weight.scaleBase) || 1)));

    storageSubtotal = Math.max(ad_amount + wt_amount, c.minStorageSubtotal||0);
    const sp=c.storageBreakdownPct;
    storageBreakdown = [
      {label:c.labels.storage.base,   amount:storageSubtotal*(sp.base||0)/100},
      {label:c.labels.storage.daily,  amount:storageSubtotal*(sp.daily||0)/100},
      {label:c.labels.storage.weight, amount:storageSubtotal*(sp.weight||0)/100},
      {label:c.labels.storage.inout,  amount:storageSubtotal*(sp.inout||0)/100}
    ];
  }

  const workItems=(cfg.workItems||[]).map(it=>({label:it.label,amount:it.amount||0}));
  const workSubtotal = workItems.reduce((s,i)=>s+i.amount,0);

  const mgmt=(c.managementFeePctOfCIF||0)>0?cif*(c.managementFeePctOfCIF/100):0;
  const taxable = storageSubtotal + workSubtotal + mgmt;
  const vat = Math.round(taxable * (c.vatPct/100));
  const shipperFee = c.shipperCodeFeeFlat||0;
  const total = Math.round(storageSubtotal + workSubtotal + mgmt + vat + shipperFee);

  return { name:cfg.name, debug:{ billCbm: billCbm }, table:{
    storage:{ title:c.labels.storage.title, rows:storageBreakdown, subtotalLabel:c.labels.storage.subtotal, subtotal:Math.round(storageSubtotal), minNote:c.labels.storage.minNote },
    work:{ title:c.labels.work.title, rows:workItems, subtotalLabel:c.labels.work.subtotal, subtotal:Math.round(workSubtotal) },
    extras:{ vatLabel:c.labels.vat+' '+c.vatPct+'%', vat:Math.round(vat), shipperLabel:c.labels.shipperCode, shipper:Math.round(shipperFee), grandLabel:c.labels.grandTotal, grand:Math.round(total) }
  }};
}

function renderPortTable(res){
  const div=document.createElement('div'); div.className='card';
  function section(title){ return `<tr><td colspan=2 style="text-align:left;font-weight:800;color:#0f172a;background:#f8fafc">${title}</td></tr>`; }
  function row(label,val){ return `<tr><td>${label}</td><td>${fmtKRW(Math.round(val))}</td></tr>`; }
  function subtotal(label,val){ return `<tr><td style="font-weight:700">${label}</td><td style="font-weight:700">${fmtKRW(Math.round(val))}</td></tr>`; }
  const t=res.table;
  const storageRows=t.storage.rows.map(r=>row(r.label,r.amount)).join('')+subtotal(t.storage.subtotalLabel,t.storage.subtotal);
  const workRows=t.work.rows.map(r=>row(r.label,r.amount)).join('')+subtotal(t.work.subtotalLabel,t.work.subtotal);
  div.innerHTML=`
    <h3 style="margin:0 0 8px 0">${res.name}</h3>
    <table>
      <thead><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th></tr></thead>
      <tbody>
        ${section(t.storage.title)}
        ${storageRows}
        ${section(t.work.title)}
        ${workRows}
        ${row(t.extras.vatLabel,t.extras.vat)}
        ${row(t.extras.shipperLabel,t.extras.shipper)}
      </tbody>
      <tfoot>
        <tr><td>${t.extras.grandLabel}</td><td>${fmtKRW(t.extras.grand)}</td></tr>
      </tfoot>
    </table>
    <div class="subtle" style="margin-top:6px">${t.storage.minNote}</div>`;
  return div;
}

function renderResults(){
  if(!lastInputs) return;
  const {totals, days, cif} = lastInputs;
  const portWrap=document.getElementById('portResults'); portWrap.innerHTML='';
  const view=document.getElementById('viewModeLabel');
  const nameMap={ALL:'ì „ì²´ ë¹„êµ',ICN:'ì¸ì²œí•­',PUS:'ë¶€ì‚°í•­'}; if(view) view.textContent='ë³´ê¸°: '+(nameMap[selectedPort]||selectedPort);
  if(selectedPort==='ALL'){
    portWrap.classList.add('two');
    portWrap.appendChild(renderPortTable(calcForPort('ICN',totals,days,cif)));
    portWrap.appendChild(renderPortTable(calcForPort('PUS',totals,days,cif)));
  }else{
    portWrap.classList.remove('two');
    portWrap.appendChild(renderPortTable(calcForPort(selectedPort,totals,days,cif)));
  }
  document.getElementById('resultSec').style.display='block';
}

// ======================== ë²„íŠ¼ ì•¡ì…˜ ========================
function onCalcClick(){
  const days=parseInt(document.getElementById('days').value||0);
  const cif = getCifKRW();
  const totals=gatherTotals();
  updateTotalsView(totals);
  if(!Number.isFinite(days)||days<0){ alert('ë³´ê´€ ì¼ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'); return; }
  if(totals.cbm===0 && totals.kg===0){ alert('CBM ë˜ëŠ” ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  lastInputs={totals,days,cif};
  renderResults();
}

function onResetClick(){
  document.getElementById('days').value='';
  document.getElementById('cif').value='';
  document.getElementById('cbm').value='';
  document.getElementById('weight').value='';
  document.getElementById('pcs').value='';
  const dimRows=document.getElementById('dimRows'); if(dimRows){ dimRows.innerHTML=''; }
  addDimRow();
  document.getElementById('resultSec').style.display='none';
  updateTotalsView({pcs:0,cbm:0,kg:0,rt:0,chargeable:0});
}

// ======================== CIF ì‹¤ì‹œê°„ í¬ë§·íŒ… ========================
function getCifKRW(){
  var el=document.getElementById('cif');
  if(!el) return 0;
  var raw=String(el.value||'');
  var n=parseInt(raw.replace(/[^\d]/g,''),10);
  return isNaN(n)?0:n;
}
function bindCifFormatter(){
  var el=document.getElementById('cif');
  if(!el || el.__kb_cif_bound) return; el.__kb_cif_bound=true;
  var composing=false;
  function fmtDigits(d){ if(!d) return ''; var n=parseInt(d,10); if(isNaN(n)) return ''; return NF.format(n); }
  function setCaretByDigits(el, digitsLeft){
    var v=el.value, seen=0, pos=0;
    for(var i=0;i<v.length;i++){ if(/[0-9]/.test(v[i])){ seen++; } pos=i+1; if(seen>=digitsLeft){ break; } }
    if(digitsLeft===0) pos=0; try{ el.setSelectionRange(pos,pos); }catch(e){}
  }
  var doFormat = throttle(function(){
    var raw=el.value; var caret=el.selectionStart||0; var digitsLeft=0; for(var i=0;i<caret;i++){ if(/[0-9]/.test(raw[i])) digitsLeft++; }
    var only=raw.replace(/[^0-9]/g,''); el.value=fmtDigits(only); setCaretByDigits(el, digitsLeft);
  }, 16);
  el.addEventListener('compositionstart', function(){ composing=true; });
  el.addEventListener('compositionend', function(){ composing=false; doFormat(); });
  el.addEventListener('input', function(){ if(!composing) doFormat(); });
  el.addEventListener('blur', function(){ if(!composing) doFormat(); });
}

// ì‹¤ì‹œê°„ í•©ê³„(ìš”ì•½) ê°±ì‹ : ëª¨ë°”ì¼ ì„±ëŠ¥ì„ ìœ„í•´ throttle ì ìš©
function liveTotals(){ updateTotalsView(gatherTotals()); }
function bindLiveTotals(){
  var h = throttle(liveTotals, 50);
  document.addEventListener('input', function(e){
    var t = e.target;
    if(t.matches('#cbm,#weight,#pcs') || t.closest('#dimRows')){ h(); }
  });
}

// ======================== ê°œë°œìš© í…ŒìŠ¤íŠ¸ ========================
// 1) ìŠ¤ëª¨í¬: ì…ë ¥â†’ê³„ì‚°â†’í¬íŠ¸/ëª¨ë“œ ì „í™˜
window.KB_testSmoke = function(){
  try{
    document.getElementById('days').value=5;
    document.getElementById('cif').value=8362000;
    document.getElementById('cbm').value=2;
    document.getElementById('weight').value=0;
    document.getElementById('pcs').value=1;
    document.getElementById('calc').click();
    document.getElementById('portPUS').click();
    document.getElementById('portICN').click();
    document.getElementById('portALL').click();
    document.getElementById('modeDIMS').click();
    document.getElementById('modeCBM').click();
    console.log('[KB Test] smoke OK');
  }catch(e){ console.error('[KB Test] failed', e); }
};
// 2) ìµœì†Œ ê³¼ê¸ˆ ê·œì¹™: PUS=1, ICN=2
window.KB_testMinRules = function(){
  try{
    var totals = { pcs:1, cbm:0.6, kg:0, rt:0.6, chargeable:0.6 };
    var d=1, cif=0;
    var rP = calcForPort('PUS', totals, d, cif);
    var rI = calcForPort('ICN', totals, d, cif);
    console.assert(rP.debug && rP.debug.billCbm === 1, '[KB Test] PUS billCbm should be 1, got', rP.debug && rP.debug.billCbm);
    console.assert(rI.debug && rI.debug.billCbm === 2, '[KB Test] ICN billCbm should be 2, got', rI.debug && rI.debug.billCbm);
    console.log('[KB Test] min rules OK');
  }catch(e){ console.error('[KB Test] min rules failed', e); }
};
// 3) ì‚¬ì´ì¦ˆ ì…ë ¥ ê³„ì‚° ê²€ì¦
window.KB_testDims = function(){
  try{
    document.getElementById('modeDIMS').click();
    var dimRows=document.getElementById('dimRows'); dimRows.innerHTML='';
    addDimRow({L:100,W:50,H:40,KG:20,PCS:2}); // 0.1*0.5*0.4=0.02 mÂ³ Ã—2=0.04
    document.getElementById('days').value=3; document.getElementById('cif').value=0;
    document.getElementById('calc').click();
    console.assert(document.getElementById('resultSec').style.display==='block', '[KB Test] dims result not visible');
    console.log('[KB Test] dims flow OK');
  }catch(e){ console.error('[KB Test] dims failed', e); }
};
// 4) í¬íŠ¸ í´ë¦­ ë™ì‘ ê²€ì¦(ì¶”ê°€)
window.KB_testPortClicks = function(){
  try{
    document.getElementById('portPUS').click();
    console.assert(selectedPort==='PUS', '[KB Test] PUS click failed, got', selectedPort);
    document.getElementById('portICN').click();
    console.assert(selectedPort==='ICN', '[KB Test] ICN click failed, got', selectedPort);
    document.getElementById('portALL').click();
    console.assert(selectedPort==='ALL', '[KB Test] ALL click failed, got', selectedPort);
    console.log('[KB Test] port clicks OK');
  }catch(e){ console.error('[KB Test] port clicks failed', e); }
};
// 5) ì ìš© ê³¼ê¸ˆ CBM ë°°ì§€ ê²€ì¦(ì‹ ê·œ): ICN=2.000, PUS=1.000
window.KB_testAppliedCbmPill = function(){
  try{
    // ICN ê²€ì‚¬
    document.getElementById('portICN').click();
    var t1 = { pcs:1, cbm:0.6, kg:0, rt:0.6, chargeable:0.6 };
    updateTotalsView(t1);
    var pills1 = Array.from(document.querySelectorAll('#totals .pill')).map(function(el){return el.textContent;});
    var applied1 = pills1.find(function(x){return x.indexOf('ì ìš© ê³¼ê¸ˆ CBM')>-1;}) || '';
    console.assert(applied1.indexOf('2.000')>-1, '[KB Test] ICN ì ìš© ê³¼ê¸ˆ CBM pill should be 2.000, got', applied1);

    // PUS ê²€ì‚¬
    document.getElementById('portPUS').click();
    var t2 = { pcs:1, cbm:0.6, kg:0, rt:0.6, chargeable:0.6 };
    updateTotalsView(t2);
    var pills2 = Array.from(document.querySelectorAll('#totals .pill')).map(function(el){return el.textContent;});
    var applied2 = pills2.find(function(x){return x.indexOf('ì ìš© ê³¼ê¸ˆ CBM')>-1;}) || '';
    console.assert(applied2.indexOf('1.000')>-1, '[KB Test] PUS ì ìš© ê³¼ê¸ˆ CBM pill should be 1.000, got', applied2);

    console.log('[KB Test] applied CBM pill OK');
  }catch(e){ console.error('[KB Test] applied CBM pill failed', e); }
};
// 6) CIF ì²œë‹¨ìœ„ í¬ë§· & íŒŒì‹± ê²€ì¦(ì‹ ê·œ)
window.KB_testCifFormat = function(){
  try{
    var el=document.getElementById('cif');
    el.focus();
    el.value='1234567';
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.blur();
    console.assert(el.value==='1,234,567', '[KB Test] CIF format failed, got', el.value);
    var val=getCifKRW();
    console.assert(val===1234567, '[KB Test] CIF parse failed, got', val);
    console.log('[KB Test] cif format OK');
  }catch(e){ console.error('[KB Test] cif format failed', e); }
};
// 7) CIF ì‹¤ì‹œê°„ ì‰¼í‘œ í¬ë§· ê²€ì¦(ì‹ ê·œ)
window.KB_testCifLiveFormat = function(){
  try{
    var el=document.getElementById('cif');
    el.value='1234567';
    el.dispatchEvent(new Event('input',{bubbles:true}));
    console.assert(el.value==='1,234,567', '[KB Test] CIF live format failed, got', el.value);
    console.log('[KB Test] cif live format OK');
  }catch(e){ console.error('[KB Test] cif live format failed', e); }
};
// 8) (ì‹ ê·œ) êµ¬ë¬¸ ì˜¤ë¥˜ ê°€ë“œ: ì£¼ìš” í•¨ìˆ˜ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
window.KB_testSyntaxGuards = function(){
  try{
    console.assert(typeof handlePort==='function', 'handlePort missing');
    console.assert(typeof bindCifFormatter==='function', 'bindCifFormatter missing');
    console.assert(typeof calcForPort==='function', 'calcForPort missing');
    console.assert(typeof throttle==='function', 'throttle missing');
    console.assert(typeof NF!=='undefined', 'NF missing');
    console.log('[KB Test] syntax guards OK');
  }catch(e){ console.error('[KB Test] syntax guards failed', e); }
};
// 9) (ì‹ ê·œ) ì¸ì²œ ìš”ìœ¨ ê²€ì¦ - ìµœì†Œ ë³´ê´€ë£Œ êµ¬ê°„
window.KB_testICNRatesSmall = function(){
  try{
    var totals = { pcs:1, cbm:0.2, kg:0, rt:0.2, chargeable:0.2 }; // billCbm -> 2
    var d=3, cif=10000000; // 1.68 + 0.27*(3-1)=2.22â€° -> 22,200ì›
    var r = calcForPort('ICN', totals, d, cif);
    console.assert(r.table.storage.subtotal === 50000, '[KB Test] ICN small subtotal should hit minimum(50,000), got', r.table.storage.subtotal);
    console.log('[KB Test] ICN small (min) OK');
  }catch(e){ console.error('[KB Test] ICN small failed', e); }
};
// 10) (ì‹ ê·œ) ì¸ì²œ ìš”ìœ¨ ê²€ì¦ - ì‚°ì‹ ì¼€ì´ìŠ¤
window.KB_testICNRatesLarge = function(){
  try{
    var totals = { pcs:1, cbm:3.0, kg:0, rt:3.0, chargeable:3.0 }; // billCbm=3
    var d=2, cif=80000000; // ad: (1.68 + 0.27*(1))â€° * 80,000,000 = 156,000
    // wt: ((1610*2) + (240*1)) * 3 = (3,220 + 240) * 3 = 10,380
    var expected = 156000 + 10380; // 166,380
    var r = calcForPort('ICN', totals, d, cif);
    console.assert(r.table.storage.subtotal === expected, '[KB Test] ICN large subtotal mismatch, expected', expected, 'got', r.table.storage.subtotal);
    console.log('[KB Test] ICN large (formula) OK');
  }catch(e){ console.error('[KB Test] ICN large failed', e); }
};
</script>
</body>
</html>
